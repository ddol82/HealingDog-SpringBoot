<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.healing.healingdog.community.model.dao.CommunityMapper">

    <select id="selectBoardHeadline" resultType="BoardTableDTO">
        SELECT
            bd.board_code
             , bd.user_code
             , bd.board_category_code
             , bd.title
             , bd.content
             , bd.uptime
             , bd.view
             , bd.share
             , COUNT(cj.user_code) AS commentCount
          FROM boards AS bd
          LEFT JOIN (
            SELECT cm.user_code
              FROM comments AS cm
          ) AS cj
            ON cj.user_code = bd.user_code
         WHERE bd.important = 'O'
         GROUP BY bd.board_code
    </select>

    <select id="selectBoardCountAll" parameterType="_int" resultType="_int">
        SELECT
               COUNT(*)
          FROM boards
         WHERE 1=1
        <if test="categoryCode != 5">
           AND board_category_code = #{ code }
        </if>
    </select>

    <select id="selectBoardList" parameterType="CatAndPageDataForBoard" resultType="BoardTableDTO">
        SELECT
               bs.board_code
             , bs.user_code
             , bs.board_category_code
             , bs.title
             , bs.content
             , bs.uptime
             , bs.view
             , bs.share
          FROM(
                SELECT
                       @rownum := @rownum+1 RN
                     , bd.board_code
                     , bd.user_code
                     , bd.board_category_code
                     , bd.title
                     , bd.content
                     , bd.uptime
                     , bd.view
                     , bd.share
                FROM boards bd
                WHERE(@rownum := 0) = 0
                <if test="categoryCode != 5">
                  AND bd.board_category_code = #{ categoryCode }
                </if>
                ORDER BY bd.board_code DESC
              ) bs
         WHERE bs.RN <![CDATA[>=]]> #{ start }
           AND bs.RN <![CDATA[<=]]> #{ end }
    </select>

    <select id="selectBoardThumbnailUrl" parameterType="_int" resultType="string">
        SELECT
               I.thumbnail
          FROM board_images I
         WHERE I.board_code = #{ code }
           AND I.thumbnail IS NOT NULL
    </select>

    <select id="selectBoardImageCount" parameterType="_int" resultType="_int">
        SELECT
               COUNT(*)
          FROM board_images I
         WHERE I.board_code = #{ code }
    </select>
    
    <insert id="insertBoard" parameterType="BoardCreateDTO" useGeneratedKeys="true" keyProperty="id">
        INSERT
          INTO boards (
               board_code
             , user_code
             , board_category_code
             , title
             , content
             , uptime
        )
        VALUES (
               NULL
             , #{ userCode }
             , #{ boardCategoryCode }
             , #{ title }
             , #{ content }
             , NOW()
        )
    </insert>
</mapper>
